<!DOCTYPE html>
<html>
  <head>
    <title>QRCode</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="./default.css" />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
  </head>
  <body>
    <div class="main">
      <ul class="tabs clearfix">
        <li class="selected">编码</li>
        <li>解码</li>
      </ul>
      <ul class="content clearfix">
        <li class="encode selected">
          <p>二维码内容：</p>
          <div><textarea id="encode-text">https://github.com/nuintun/qrcode</textarea></div>
          <p>
            <label>支持 FNC1：</label>
            <select id="hints-fnc1">
              <option value="NONE" selected>否</option>
              <option value="AIM">AIM</option>
              <option value="GS1">GS1</option>
            </select>
            <label class="indent">AIM 标识：</label>
            <input disabled id="aim-indicator" type="number" min="0" max="255" value="0" />
          </p>
          <p>
            <label>纠错等级：</label>
            <select id="encode-level">
              <option value="L">Level L (7%)</option>
              <option value="M" selected>Level M (15%)</option>
              <option value="Q">Level Q (25%)</option>
              <option value="H">Level H (30%)</option>
            </select>
            <label class="indent">编码方式：</label>
            <select id="encode-mode">
              <option value="Auto" selected>Auto</option>
              <option value="Alphanumeric">Alphanumeric</option>
              <option value="Byte">Byte</option>
              <option value="Hanzi">Hanzi</option>
              <option value="Kanji">Kanji</option>
              <option value="Numeric">Numeric</option>
            </select>
            <label class="indent">字符集：</label>
            <select id="encode-charset">
              <option value="ASCII">ASCII</option>
              <option value="UTF_8" selected>UTF-8</option>
              <option value="ISO_8859_1">ISO-8859-1</option>
            </select>
          </p>
          <p>
            <label>前景颜色：</label>
            <input id="gif-foreground" type="color" value="#000000" />
            <label class="indent">背景颜色：</label>
            <input id="gif-background" type="color" value="#ffffff" />
            <label class="indent">色块大小：</label>
            <input id="encode-msize" type="number" min="1" max="10" value="1" />
            <label class="indent">留白大小：</label>
            <input title="推荐设置为4倍色块大小" id="encode-margin" type="number" min="0" max="40" value="4" />
          </p>
          <p>
            <button id="encode-btn">编码</button>
          </p>
          <pre id="encode-result" class="encode-result hide"></pre>
        </li>
        <li class="decode">
          <p><label>二维码图片：</label><input type="file" accept="image/*" id="decode-file" /></p>
          <div>
            <canvas id="decode-canvas"></canvas>
          </div>
          <p>
            <button id="decode-btn">解码</button>
          </p>
          <pre id="decode-result" class="decode-result hide"></pre>
        </li>
      </ul>
    </div>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.slim.min.js"></script>
    <script type="text/javascript" src="./qrcode.js"></script>
    <script type="text/javascript">
      // Tab 切换
      const nav = $('.tabs li');
      const content = $('.content li');

      nav.on('click', function () {
        const target = $(this);

        nav.removeClass('selected');

        target.addClass('selected');

        content.removeClass('selected').eq(target.index()).addClass('selected');
      });

      const hintsFNC1 = $('#hints-fnc1');
      const encodeMode = $('#encode-mode');
      const encodeText = $('#encode-text');
      const encodeLevel = $('#encode-level');
      const encodeMSize = $('#encode-msize');
      const aimIndicator = $('#aim-indicator');
      const encodeMargin = $('#encode-margin');
      const encodeResult = $('#encode-result');
      const encodeCharset = $('#encode-charset');
      const gifBackground = $('#gif-background');
      const gifForeground = $('#gif-foreground');

      hintsFNC1.on('change', function () {
        aimIndicator.prop('disabled', hintsFNC1.val() !== 'AIM');
      });

      encodeMode.on('change', function () {
        const mode = encodeMode.val();

        encodeCharset.prop('disabled', mode !== 'Auto' && mode !== 'Byte');
      });

      function getFNC1Hint() {
        switch (hintsFNC1.val()) {
          case 'GS1':
            return ['GS1'];
          case 'AIM':
            return ['AIM', +aimIndicator.val()];
        }
      }

      function hex2rgb(hex) {
        hex = parseInt(hex.replace('#', '0x'));

        return [(hex >> 16) & 0xff, (hex >> 8) & 0xff, hex & 0xff];
      }

      const NUMERIC_RE = /^\d+$/;
      const ALPHANUMERIC_RE = /^[0-9A-Z$%*+-./: ]+$/;

      function chooseBestMode(mode, data) {
        if (mode === 'Auto') {
          if (NUMERIC_RE.test(data)) {
            return new QRCode.Numeric(data);
          } else if (ALPHANUMERIC_RE.test(data)) {
            return new QRCode.Alphanumeric(data);
          }

          const hanzi = new QRCode.Hanzi(data);

          try {
            hanzi.encode();

            return hanzi;
          } catch {
            // 跳过错误
          }

          const kanji = new QRCode.Kanji(data);

          try {
            kanji.encode();

            return kanji;
          } catch {
            // 跳过错误
          }

          // 回退字节模式
          mode = 'Byte';
        }

        return new QRCode[mode](data, QRCode.Charset[encodeCharset.val()]);
      }

      // 生成二维码
      $('#encode-btn').on('click', function () {
        const data = encodeText.val();
        const mode = encodeMode.val();
        const level = encodeLevel.val();
        const margin = parseInt(encodeMargin.val());
        const moduleSize = parseInt(encodeMSize.val());
        const background = hex2rgb(gifBackground.val());
        const foreground = hex2rgb(gifForeground.val());

        encodeResult.removeClass('hide');

        try {
          const encoder = new QRCode.Encoder({
            level,
            version: 'auto',
            hints: { fnc1: getFNC1Hint() }
          });

          console.dir(encoder);
          console.dir(QRCode.Charset);

          const segment = chooseBestMode(mode, data);

          console.time('encode');
          const qrcode = encoder.encode(chooseBestMode(mode, data));
          console.timeEnd('encode');

          console.dir(qrcode);

          console.time('toDataURL');
          const url = qrcode.toDataURL(moduleSize, { margin, foreground, background });
          console.timeEnd('toDataURL');

          encodeResult.html(`<img src="${url}" />`);

          const decoder = new QRCode.Decoder();

          const matrix = qrcode.matrix;
          const size = matrix.size;
          const bitMatrix = new QRCode.BitMatrix(size, size);
          const bitMatrixMirror = new QRCode.BitMatrix(size, size);

          for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
              if (matrix.get(x, y) === 1) {
                bitMatrix.set(x, y);
                bitMatrixMirror.set(y, x);
              }
            }
          }

          console.time('decode');
          console.dir(decoder.decode(bitMatrix));
          console.timeEnd('decode');
          console.time('decode mirror');
          console.dir(decoder.decode(bitMatrixMirror));
          console.timeEnd('decode mirror');
        } catch (error) {
          encodeResult.html(`<span class="error">${error.message}</span>`);

          console.error(error);
        }
      });

      let hasImage = false;
      let imageData = null;

      const canvas = $('#decode-canvas')[0];
      const decodeResult = $('#decode-result');
      const context = canvas.getContext('2d', { willReadFrequently: true });

      function resetDecoder() {
        hasImage = false;
        imageData = null;
      }

      function drawImage(src) {
        const img = new Image();

        img.crossOrigin = 'anonymous';

        img.onload = function () {
          const width = img.width;
          const height = img.height;
          const actualWidth = Math.min(960, width);
          const actualHeight = height * (actualWidth / width);

          hasImage = true;
          canvas.width = actualWidth;
          canvas.height = actualHeight;

          context.drawImage(img, 0, 0, width, height, 0, 0, actualWidth, actualHeight);

          imageData = context.getImageData(0, 0, actualWidth, actualHeight);
        };

        img.src = src;
      }

      // 二维码加载
      $('#decode-file').on('change', function (e) {
        const file = e.target.files[0];

        if (file) {
          resetDecoder();

          const reader = new FileReader();

          reader.onload = function (e) {
            drawImage(e.target.result);
          };

          reader.readAsDataURL(file);
        }
      });

      function getImageData() {
        imageData && context.putImageData(imageData, 0, 0);

        return imageData || context.getImageData(0, 0, canvas.width, canvas.height);
      }

      function markFinderPattern({ x, y, moduleSize }, color) {
        context.fillStyle = color;

        context.beginPath();
        context.arc(x, y, moduleSize * 0.75, 0, 2 * Math.PI);
        context.fill();
      }

      $('#decode-btn').on('click', function () {
        decodeResult.removeClass('hide');

        if (!hasImage) {
          return decodeResult.html(`<span class="error">请选择二维码图片</span>`);
        }

        const imageData = getImageData();
        const { width, height } = imageData;
        const decoder = new QRCode.Decoder();
        const matrix = QRCode.binarize(imageData, width, height);
        const detector = new QRCode.Detector(matrix);
        const detected = detector.detect();

        if (detected.length > 0) {
          const success = [];

          for (const { matrix, patterns } of detected) {
            try {
              const decoded = decoder.decode(matrix);
              const { content } = decoded;

              decodeResult.html(content);
              success.push(patterns);

              console.dir(matrix);
              console.dir(patterns);
              console.dir(decoded);
              console.dir(content);
            } catch {
              // 解码失败，跳过
            }

            for (const { topLeft, topRight, bottomLeft } of success) {
              markFinderPattern(topLeft, '#00ff00');
              markFinderPattern(topRight, '#00ff00');
              markFinderPattern(bottomLeft, '#00ff00');
            }
          }
        } else {
          decodeResult.html(`<span class="error">未发现二维码</span>`);
        }
      });

      /https?:/i.test(location.protocol) && drawImage('./qrcode.jpg');
    </script>
  </body>
</html>

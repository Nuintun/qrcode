<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel="StyleSheet" type="text/css" href="default.test.css">
  <title>QRCode</title>
  <style type="text/css">
    body {
      overflow-y: scroll;
    }

    html *,
    body * {
      font-family: MICROSOFT YAHEI, serif;
    }

    textarea {
      resize: none;
      width: 100%;
    }

    button {
      margin: 0;
    }

  </style>
</head>

<body>
  <div class="main">
    <ul class="tabs clearfix">
      <li class="selected">编码</li>
    </ul>
    <ul class="content clearfix">
      <li class="decode">
        <p><label>选择二维码图片：</label><input type="file" name="files[]" id="decode-file" /></p>

        <div>
          <canvas id="decode-canvas"></canvas>
        </div>
        <p>
          <button id="decode-btn">解码</button>
        </p>
        <p id="decode-text" class="hide">解码值为：<br/><br/><textarea></textarea></p>
      </li>
    </ul>
  </div>

  <script src="jquery-1.11.3.js"></script>
  <script type="text/javascript" src="../src/findpat.js"></script>
  <script type="text/javascript" src="../src/grid.js"></script>
  <script type="text/javascript" src="../src/detector.js"></script>
  <script type="text/javascript">
    var canvas = $('#decode-canvas')[0];
    var ctx = canvas.getContext('2d');
    var qrcode = {};

    qrcode.getMiddleBrightnessPerArea = function(image) {
      var numSqrtArea = 4;
      //obtain middle brightness((min + max) / 2) per area
      var areaWidth = Math.floor(qrcode.width / numSqrtArea);
      var areaHeight = Math.floor(qrcode.height / numSqrtArea);
      var minmax = new Array(numSqrtArea);
      for (var i = 0; i < numSqrtArea; i++) {
        minmax[i] = new Array(numSqrtArea);
        for (var i2 = 0; i2 < numSqrtArea; i2++) {
          minmax[i][i2] = new Array(0, 0);
        }
      }
      for (var ay = 0; ay < numSqrtArea; ay++) {
        for (var ax = 0; ax < numSqrtArea; ax++) {
          minmax[ax][ay][0] = 0xFF;
          for (var dy = 0; dy < areaHeight; dy++) {
            for (var dx = 0; dx < areaWidth; dx++) {
              var target = image[areaWidth * ax + dx + (areaHeight * ay + dy) * qrcode.width];
              if (target < minmax[ax][ay][0])
                minmax[ax][ay][0] = target;
              if (target > minmax[ax][ay][1])
                minmax[ax][ay][1] = target;
            }
          }
          //minmax[ax][ay][0] = (minmax[ax][ay][0] + minmax[ax][ay][1]) / 2;
        }
      }
      var middle = new Array(numSqrtArea);
      for (var i3 = 0; i3 < numSqrtArea; i3++) {
        middle[i3] = new Array(numSqrtArea);
      }
      for (var ay = 0; ay < numSqrtArea; ay++) {
        for (var ax = 0; ax < numSqrtArea; ax++) {
          middle[ax][ay] = Math.floor((minmax[ax][ay][0] + minmax[ax][ay][1]) / 2);
          //Console.out.print(middle[ax][ay] + ",");
        }
        //Console.out.println("");
      }
      //Console.out.println("");

      return middle;
    }

    qrcode.grayScaleToBitmap = function(grayScale) {
      var middle = qrcode.getMiddleBrightnessPerArea(grayScale);
      var sqrtNumArea = middle.length;
      var areaWidth = Math.floor(qrcode.width / sqrtNumArea);
      var areaHeight = Math.floor(qrcode.height / sqrtNumArea);
      var bitmap = new Array(qrcode.height * qrcode.width);

      for (var ay = 0; ay < sqrtNumArea; ay++) {
        for (var ax = 0; ax < sqrtNumArea; ax++) {
          for (var dy = 0; dy < areaHeight; dy++) {
            for (var dx = 0; dx < areaWidth; dx++) {
              bitmap[areaWidth * ax + dx + (areaHeight * ay + dy) * qrcode.width] = (grayScale[areaWidth * ax +
                dx + (areaHeight * ay + dy) * qrcode.width] < middle[ax][ay]) ? true : false;
            }
          }
        }
      }
      return bitmap;
    }

    qrcode.getPixel = function(x, y) {
      if (qrcode.width < x) {
        throw "point error";
      }
      if (qrcode.height < y) {
        throw "point error";
      }
      point = (x * 4) + (y * qrcode.width * 4);
      p = (qrcode.imagedata.data[point] * 33 + qrcode.imagedata.data[point + 1] * 34 + qrcode.imagedata.data[point + 2] * 33) / 100;
      return p;
    }

    qrcode.grayscale = function() {
      var ret = new Array(qrcode.width * qrcode.height);
      for (var y = 0; y < qrcode.height; y++) {
        for (var x = 0; x < qrcode.width; x++) {
          var gray = qrcode.getPixel(x, y);

          ret[x + y * qrcode.width] = gray;
        }
      }
      return ret;
    }

    // 二维码加载
    $('#decode-file').on('change', function(e) {
      var file = e.target.files[0];
      var reader = new FileReader();

      reader.onload = (function(e) {
        var img = new Image();

        img.onload = function() {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
        };

        img.src = e.target.result;
      });

      file && reader.readAsDataURL(file);
    });

    $('#decode-btn').on('click', function() {
      var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

      qrcode.width = canvas.width;
      qrcode.height = canvas.height;
      qrcode.imagedata = imageData;

      imageData = qrcode.grayScaleToBitmap(qrcode.grayscale());

      window.DecodeTest = new Detector(imageData, canvas.width, canvas.height);

      console.log(DecodeTest.detect());
    });

  </script>
</body>

</html>
